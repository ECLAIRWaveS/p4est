name: CI for libsc submodule checking

on:
  pull_request:

jobs:

  linux-sub:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source code
      uses: actions/checkout@v3
      with:
        submodules: true

    - name: Set environment variables
      shell: bash
      run: |
        EVENT_PATH="${GITHUB_EVENT_PATH}"
        cd "${GITHUB_WORKSPACE}" \
        || error "__Line:${LINENO}__Error: Cannot change directory to Github Workspace"
        PR=`jq -r ".number" "${EVENT_PATH}"`
        PR_BRANCH=`jq -r ".pull_request.head.ref" "${EVENT_PATH}"`
        BASE_BRANCH=`jq -r ".pull_request.base.ref" "${EVENT_PATH}"`
        INPUT_PATH="sc"
        echo "Run for PR # ${PR} of ${PR_BRANCH} into ${BASE_BRANCH}"
        echo "Get PR Branches"
        echo "Fetch Branch Histories"
        echo "Full Brach Histories"
        git fetch origin "${PR_BRANCH}" --recurse-submodules=no --depth 1 \
        || error "__Line:${LINENO}__Error: Could not fetch history of ${PR_BRANCH}"
        git fetch origin "${BASE_BRANCH}" --recurse-submodules=no --depth 1 \
        || error "__Line:${LINENO}__Error: Could not fetch history of ${BASE_BRANCH}"
        TO_HASH=`git rev-parse origin/${PR_BRANCH}`
        FROM_HASH=`git rev-parse origin/${BASE_BRANCH}`
        echo "Hash ${TO_HASH} into ${FROM_HASH}"

    - name: Check SC submodule unchabged
      shell: bash
      run: |
        CHANGED=`git diff --name-only ${FROM_HASH}...${TO_HASH}`
        if grep "^${INPUT_PATH}$" <<< "${CHANGED}"; then
          echo "Submodule has been changed by this PR. It is forbidden by the \
                repository policy."
          exit 1
        if
        echo "Success: submodule has not been changed."
        exit 0
